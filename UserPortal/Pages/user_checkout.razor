@page "/user_checkout"
@using System.Text.Json
@inject HttpClient Http
@inject IJSRuntime JS
@inject NavigationManager NavManager

<h3 style="text-align:center; color:#222;">🧾 Checkout</h3>

@if (isLoading)
{
    <div style="text-align:center; margin-top:50px;">
        <p>Loading cart...</p>
        <div class="spinner"></div>
    </div>
}
else if (!cartItems.Any())
{
    <p style="text-align:center; margin-top:50px;">Your cart is empty.</p>
}
else
{
    <div class="checkout-container">
        <div class="cart-summary">
            <h4>🛒 Items in your cart</h4>
            @foreach (var item in cartItems)
            {
                <div class="cart-item">
                    <img src="@GetFullImageUrl(item.ImageUrl)" class="cart-img" />
                    <div class="cart-info">
                        <strong>@item.Name</strong>
                        <p>₹@item.Price x @item.Quantity</p>
                    </div>
                </div>
            }

            <hr />
            <h4>Total: ₹@totalAmount</h4>
        </div>

        <div class="address-form">
            <h4>📦 Shipping Address</h4>

            <input placeholder="Full Name" @bind="address.FullName" />
            <input placeholder="Address Line 1" @bind="address.Line1" />
            <input placeholder="City" @bind="address.City" />
            <input placeholder="Postal Code" @bind="address.PostalCode" />
            <input placeholder="Phone" @bind="address.Phone" />
            <button @onclick="PayOnline" class="btn-place">Pay Online (Stripe)</button>

            <button @onclick="PlaceOrder" class="btn-place">Place Order</button>
        </div>
    </div>
}

@if (!string.IsNullOrEmpty(message))
{
    <div style="text-align:center; margin-top:20px;">
        <p>@message</p>
    </div>
}

<style>
    .checkout-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        padding: 20px;
    }

    .cart-summary, .address-form {
        background: #fff;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    .cart-item {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }

    .cart-img {
        width: 70px;
        height: 70px;
        object-fit: cover;
        border-radius: 8px;
        margin-right: 10px;
    }

    .cart-info p {
        margin: 0;
        font-size: 14px;
        color: #555;
    }

    input {
        width: 100%;
        padding: 8px;
        margin: 5px 0;
        border: 1px solid #ccc;
        border-radius: 5px;
    }

    .btn-place {
        width: 100%;
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px;
        border-radius: 5px;
        cursor: pointer;
        margin-top: 10px;
    }

        .btn-place:hover {
            background-color: #0056b3;
        }

    .spinner {
        border: 6px solid #f3f3f3;
        border-top: 6px solid #333;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        margin: 20px auto;
        animation: spin 1s linear infinite;
    }
</style>

@code {
    private List<CartItem> cartItems = new();
    private bool isLoading = true;
    private string message = "";
    private decimal totalAmount = 0;
    private OrderAddress address = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadCart();
    }
    // private async Task PayOnline()
    // {
    //     try
    //     {
    //         var item = cartItems.First();

    //         var request = new
    //         {
    //             OrderId = item.CartItemID,
    //             Amount = item.Price * item.Quantity,
    //             ProductName = item.Name
    //         };

    //         var response =  await Http.PostAsJsonAsync("api/Payment/CreateCheckoutSession",
    // new
    // {
    //     ProductName = "Test",
    //     Amount = 100
    // });

    //         if (!response.IsSuccessStatusCode)
    //         {
    //             await JS.InvokeVoidAsync("alert", "Stripe session creation failed!");
    //             return;
    //         }

    //         var data = await response.Content.ReadFromJsonAsync<Dictionary<string, string>>();
    //         var url = data["url"];

    //         if (string.IsNullOrWhiteSpace(url))
    //         {
    //             await JS.InvokeVoidAsync("alert", "Stripe returned empty checkout URL!");
    //             return;
    //         }

    //         // 🔥 FIX: Proper redirect to Stripe
    //         await JS.InvokeVoidAsync("eval", $"window.location.href='{url}'");
    //     }
    //     catch (Exception ex)
    //     {
    //         await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
    //     }
    // }

    // private async Task PayOnline()
    // {
    //     try
    //     {
    //         var response = await Http.PostAsJsonAsync(
    //             "api/Payment/CreateCheckoutSession",
    //             new
    //             {
    //                 ProductName = "Test",
    //                 Amount = 100
    //             });

    //         if (!response.IsSuccessStatusCode)
    //         {
    //             await JS.InvokeVoidAsync("alert", "Stripe session creation failed!");
    //             return;
    //         }

    //         var data = await response.Content.ReadFromJsonAsync<Dictionary<string, string>>();
    //         var url = data["url"];

    //         if (string.IsNullOrWhiteSpace(url))
    //         {
    //             await JS.InvokeVoidAsync("alert", "Stripe returned empty checkout URL!");
    //             return;
    //         }

    //         // 🔥 FINAL FIX – correct redirection
    //         await JS.InvokeVoidAsync("open", url, "_self");
    //         // or: await JS.InvokeVoidAsync("open", url, "_blank");
    //     }
    //     catch (Exception ex)
    //     {
    //         await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
    //     }
    // }
    // private async Task PayOnline()
    // {
    //     try
    //     {
    //         var response = await Http.PostAsJsonAsync(
    //             "api/Payment/create-checkout-session",
    //             new
    //             {
    //                 orderId = Guid.NewGuid(),
    //                 amount = 100,
    //                 productName = "Test"
    //             });

    //         if (!response.IsSuccessStatusCode)
    //         {
    //             await JS.InvokeVoidAsync("alert", "Stripe session creation failed!");
    //             return;
    //         }

    //         var options = new JsonSerializerOptions
    //         {
    //             PropertyNameCaseInsensitive = true
    //         };

    //         var data = await response.Content.ReadFromJsonAsync<Dictionary<string, string>>(options);

    //         var url = data["url"]; // stripe checkout url

    //         await JS.InvokeVoidAsync("redirectToStripe", url);
    //     }
    //     catch (Exception ex)
    //     {
    //         await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
    //     }
    // }
    // private async Task PayOnline()
    // {
    //     var response = await Http.PostAsJsonAsync(
    //         "api/Payment/create-checkout-session",
    //         new { amount = 100, productName = "Test" }
    //     );

    //     // var result = await response.Content.ReadFromJsonAsync<Dictionary<string, string>>();
    //     // var url = result["url"];

    //     // await JS.InvokeVoidAsync("redirectToStripe", url);
    //     var result = await Http.PostAsJsonAsync("create-checkout-session", new { });
    //     var data = await result.Content.ReadFromJsonAsync<CheckoutResponse>();

    //     await JS.InvokeVoidAsync("redirectToStripe", data.url);

    // }
    private async Task PayOnline()
    {
        var response = await Http.PostAsJsonAsync(
            "api/Payment/create-checkout-session",
            new { amount = totalAmount, productName = "Cart Order" }
        );

        var data = await response.Content.ReadFromJsonAsync<CheckoutResponse>();
        await JS.InvokeVoidAsync("redirectToStripe", data.url);
    }




    // private async Task PayOnline()
    // {
    //     try
    //     {
    //         var response = await Http.PostAsJsonAsync(
    //             "https://localhost:7117/api/Payment/create-checkout-session",
    //             new
    //             {
    //                 orderId = Guid.NewGuid(),
    //                 amount = 100,
    //                 productName = "Test"
    //             });

    //         if (!response.IsSuccessStatusCode)
    //         {
    //             await JS.InvokeVoidAsync("alert", "Stripe session creation failed!");
    //             return;
    //         }

    //         var options = new JsonSerializerOptions
    //         {
    //             PropertyNameCaseInsensitive = true
    //         };

    //         var data = await response.Content.ReadFromJsonAsync<Dictionary<string, string>>(options);
    //         var url = data["url"];

    //         if (string.IsNullOrWhiteSpace(url))
    //         {
    //             await JS.InvokeVoidAsync("alert", "Stripe returned empty checkout URL!");
    //             return;
    //         }

    //         // 🔥 Safe redirect (no exception)
    //         await JS.InvokeVoidAsync("redirectToStripe", url);
    //     }
    //     catch (Exception ex)
    //     {
    //         await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
    //     }
    // }

    private async Task LoadCart()
    {
        try
        {
            var token = await JS.InvokeAsync<string>("localStorage.getItem", "authToken");
            if (string.IsNullOrEmpty(token))
            {
                NavManager.NavigateTo("/");
                return;
            }

            Http.DefaultRequestHeaders.Authorization =
                new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);

            var response = await Http.GetAsync("https://localhost:7117/api/Cart/GetByUser");
            if (response.IsSuccessStatusCode)
            {
                cartItems = await response.Content.ReadFromJsonAsync<List<CartItem>>() ?? new List<CartItem>();
                totalAmount = cartItems.Sum(x => x.Price * x.Quantity);
            }
            else
            {
                message = "❌ Error loading cart!";
            }
        }
        catch (Exception ex)
        {
            message = $"❌ Error: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task PlaceOrder()
    {
        try
        {
            var token = await JS.InvokeAsync<string>("localStorage.getItem", "authToken");
            if (string.IsNullOrEmpty(token))
            {
                NavManager.NavigateTo("/");
                return;
            }

            Http.DefaultRequestHeaders.Authorization =
                new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);

            if (cartItems == null || !cartItems.Any())
            {
                await JS.InvokeVoidAsync("alert", "Your cart is empty!");
                return;
            }

            // Place each cart item as separate order (backend expects single CartItemId)
            foreach (var item in cartItems)
            {
                var orderRequest = new CreateOrderRequest
                {
                    CartItemId = item.CartItemID,
                    PaymentMethod = "COD",
                    ShippingAmount = 0,
                    TaxAmount = 0,
                    FullName = address.FullName,
                    Line1 = address.Line1,
                    Line2 = "", // optional
                    City = address.City,
                    State = "", // optional
                    PostalCode = address.PostalCode,
                    Country = "India",
                    Phone = address.Phone
                };

                var jsonOptions = new System.Text.Json.JsonSerializerOptions
                {
                    PropertyNamingPolicy = null
                };

                var response = await Http.PostAsJsonAsync("https://localhost:7117/api/Orders/Create", orderRequest, jsonOptions);

                if (!response.IsSuccessStatusCode)
                {
                    var err = await response.Content.ReadAsStringAsync();
                    message = $"❌ Failed to place order for {item.Name}. ({response.StatusCode})\n{err}";
                    return;
                }
            }

            message = "✅ Order placed successfully!";
            await JS.InvokeVoidAsync("alert", "Order placed successfully!");
            NavManager.NavigateTo("/user_orders");
        }
        catch (Exception ex)
        {
            message = $"❌ Error placing order: {ex.Message}";
        }
    }

    private string GetFullImageUrl(string relativeUrl)
    {
        if (string.IsNullOrWhiteSpace(relativeUrl))
            return "images/noimage.png";

        return relativeUrl.StartsWith("http")
            ? relativeUrl
            : $"https://localhost:7117/{relativeUrl.TrimStart('/')}";
    }

    public class CartItem
    {
        public Guid CartItemID { get; set; }
        public Guid ProductId { get; set; }
        public Guid Appuserid { get; set; }
        public string Name { get; set; } = "";
        public string Description { get; set; } = "";
        public decimal Price { get; set; }
        public int Quantity { get; set; }
        public string ImageUrl { get; set; } = "";
    }

    public class OrderAddress
    {
        public string FullName { get; set; } = "";
        public string Line1 { get; set; } = "";
        public string City { get; set; } = "";
        public string PostalCode { get; set; } = "";
        public string Phone { get; set; } = "";
    }

    public class CreateOrderRequest
    {
        public Guid CartItemId { get; set; }
        public string? PaymentMethod { get; set; }
        public decimal ShippingAmount { get; set; }
        public decimal TaxAmount { get; set; }

        public string FullName { get; set; } = "";
        public string Line1 { get; set; } = "";
        public string? Line2 { get; set; }
        public string City { get; set; } = "";
        public string State { get; set; } = "";
        public string PostalCode { get; set; } = "";
        public string Country { get; set; } = "India";
        public string Phone { get; set; } = "";
    }
    public class StripeCheckoutRequest
    {
        public decimal Amount { get; set; }
        public string ProductName { get; set; } = "";
        public string Description { get; set; } = "";
        public string ImageUrl { get; set; } = "";
    }

    public class CheckoutResponse
    {
        public string url { get; set; }
    }

}

@* @page "/user_checkout"
@inject HttpClient Http
@inject IJSRuntime JS
@inject NavigationManager NavManager

<h3 style="text-align:center; color:#222;">🧾 Checkout</h3>

@if (isLoading)
{
    <div style="text-align:center; margin-top:50px;">
        <p>Loading cart...</p>
        <div class="spinner"></div>
    </div>
}
else if (!cartItems.Any())
{
    <p style="text-align:center; margin-top:50px;">Your cart is empty.</p>
}
else
{
    <div class="checkout-container">
        <div class="cart-summary">
            <h4>🛒 Items in your cart</h4>
            @foreach (var item in cartItems)
            {
                <div class="cart-item">
                    <img src="@GetFullImageUrl(item.ImageUrl)" class="cart-img" />
                    <div class="cart-info">
                        <strong>@item.Name</strong>
                        <p>₹@item.Price x @item.Quantity</p>
                    </div>
                </div>
            }

            <hr />
            <h4>Total: ₹@totalAmount</h4>
        </div>

        <div class="address-form">
            <h4>📦 Shipping Address</h4>

            <input placeholder="Full Name" @bind="address.FullName" />
            <input placeholder="Address Line 1" @bind="address.Line1" />
            <input placeholder="City" @bind="address.City" />
            <input placeholder="Postal Code" @bind="address.PostalCode" />
            <input placeholder="Phone" @bind="address.Phone" />

            <button @onclick="PlaceOrder" class="btn-place">Place Order</button>
        </div>
    </div>
}

@if (!string.IsNullOrEmpty(message))
{
    <div style="text-align:center; margin-top:20px;">
        <p>@message</p>
    </div>
}

<style>
    .checkout-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        padding: 20px;
    }

    .cart-summary, .address-form {
        background: #fff;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    .cart-item {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }

    .cart-img {
        width: 70px;
        height: 70px;
        object-fit: cover;
        border-radius: 8px;
        margin-right: 10px;
    }

    .cart-info p {
        margin: 0;
        font-size: 14px;
        color: #555;
    }

    input {
        width: 100%;
        padding: 8px;
        margin: 5px 0;
        border: 1px solid #ccc;
        border-radius: 5px;
    }

    .btn-place {
        width: 100%;
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px;
        border-radius: 5px;
        cursor: pointer;
        margin-top: 10px;
    }

        .btn-place:hover {
            background-color: #0056b3;
        }

    .spinner {
        border: 6px solid #f3f3f3;
        border-top: 6px solid #333;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        margin: 20px auto;
        animation: spin 1s linear infinite;
    }

    
</style>

@code {
    private List<CartItem> cartItems = new();
    private bool isLoading = true;
    private string message = "";
    private decimal totalAmount = 0;
    private OrderAddress address = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadCart();
    }
        
    private async Task LoadCart()
    {
        try
        {
            var token = await JS.InvokeAsync<string>("localStorage.getItem", "authToken");
            if (string.IsNullOrEmpty(token))
            {
                NavManager.NavigateTo("/");
                return;
            }

            Http.DefaultRequestHeaders.Authorization =
                new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);

            var response = await Http.GetAsync("https://localhost:7117/api/Cart/GetByUser");
            if (response.IsSuccessStatusCode)
            {
                cartItems = await response.Content.ReadFromJsonAsync<List<CartItem>>() ?? new List<CartItem>();
                totalAmount = cartItems.Sum(x => x.Price * x.Quantity);
            }
            else
            {
                message = "❌ Error loading cart!";
            }
        }
        catch (Exception ex)
        {
            message = $"❌ Error: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task PlaceOrder()
    {
        try
        {
            var token = await JS.InvokeAsync<string>("localStorage.getItem", "authToken");
            if (string.IsNullOrEmpty(token))
            {
                NavManager.NavigateTo("/");
                return;
            }

            Http.DefaultRequestHeaders.Authorization =
                new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);

            if (cartItems == null || !cartItems.Any())
            {
                await JS.InvokeVoidAsync("alert", "Your cart is empty!");
                return;
            }

            var orderObject = new CreateOrderDto
            {
                TotalAmount = totalAmount,
                SubTotalAmount = totalAmount,
                ShippingAmount = 0,
                TaxAmount = 0,
                PaymentStatus = "Pending",
                OrderStatus = "New",
                PaymentMethod = "COD",
                IsActive = true,
                IsDeleted = false,
                OrderItems = cartItems.Select(c => new OrderItemDto
                {
                    CartItemId = c.CartItemID,

                    ProductId = c.ProductId,
                    ProductName = c.Name,
                    Description = c.Description,
                    ImageUrl = c.ImageUrl,
                    UnitPrice = c.Price,
                    Quantity = c.Quantity
                }).ToList(),

                OrderAddresses = new List<OrderAddressDto>
                {
                    new OrderAddressDto
                    {
                        FullName = address.FullName,
                        Line1 = address.Line1,
                        City = address.City,
                        PostalCode = address.PostalCode,
                        Phone = address.Phone
                    }
                }
            };

            var jsonOptions = new System.Text.Json.JsonSerializerOptions
            {
                PropertyNamingPolicy = null // 👈 ensure backend PascalCase match
            };

            var response = await Http.PostAsJsonAsync("https://localhost:7117/api/Orders/Create", orderObject, jsonOptions);

            if (response.IsSuccessStatusCode)
            {
                message = "✅ Order placed successfully!";
                await JS.InvokeVoidAsync("alert", "Order placed successfully!");
                NavManager.NavigateTo("/user_orders");
            }
            else
            {
                var err = await response.Content.ReadAsStringAsync();
                message = $"❌ Failed to place order. ({response.StatusCode})\n{err}";
            }
        }
        catch (Exception ex)
        {
            message = $"❌ Error placing order: {ex.Message}";
        }
    }

    private string GetFullImageUrl(string relativeUrl)
    {
        if (string.IsNullOrWhiteSpace(relativeUrl))
            return "images/noimage.png";

        return relativeUrl.StartsWith("http")
            ? relativeUrl
            : $"https://localhost:7117/{relativeUrl.TrimStart('/')}";
    }

    // ------------------ MODELS ------------------
    public class CartItem
    {
        public Guid CartItemID { get; set; }

        public Guid ProductId { get; set; }
        public Guid Appuserid { get; set; }
        public string Name { get; set; } = "";
        public string Description { get; set; } = "";
        public decimal Price { get; set; }
        public int Quantity { get; set; }
        public string ImageUrl { get; set; } = "";
    }

    public class OrderAddress
    {
        public string FullName { get; set; } = "";
        public string Line1 { get; set; } = "";
        public string City { get; set; } = "";
        public string PostalCode { get; set; } = "";
        public string Phone { get; set; } = "";
    }

    public class CreateOrderDto
    {
        public decimal TotalAmount { get; set; }
        public decimal SubTotalAmount { get; set; }
        public decimal ShippingAmount { get; set; }
        public decimal TaxAmount { get; set; }
        public string PaymentStatus { get; set; } = "Pending";
        public string OrderStatus { get; set; } = "New";
        public string PaymentMethod { get; set; } = "COD";
        public bool IsActive { get; set; } = true;
        public bool IsDeleted { get; set; } = false;
        public List<OrderItemDto> OrderItems { get; set; } = new();
        public List<OrderAddressDto> OrderAddresses { get; set; } = new();
    }

    public class OrderItemDto
    {
        public Guid CartItemId { get; set; }

        public Guid ProductId { get; set; }
        public string ProductName { get; set; } = "";
        public string Description { get; set; } = "";
        public string ImageUrl { get; set; } = "";
        public decimal UnitPrice { get; set; }
        public int Quantity { get; set; }
    }

    public class OrderAddressDto
    {
        public string AddressType { get; set; } = "Shipping";
        public string FullName { get; set; } = "";
        public string Line1 { get; set; } = "";
        public string City { get; set; } = "";
        public string PostalCode { get; set; } = "";
        public string Country { get; set; } = "India";
        public string Phone { get; set; } = "";
    }
}
 *@