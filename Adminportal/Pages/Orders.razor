@page "/orders"
@inject HttpClient Http
@inject IJSRuntime JS
@inject NavigationManager NavManager
@using System.Text.Json
@using System.Linq
<Sidebar />
<div style="margin-left: 240px;">
    <h3 class="page-title">📦 My Orders</h3>

    @if (isLoading)
    {
        <div class="loading-box">
            <p>Loading your orders...</p>
            <div class="spinner"></div>
        </div>
    }
    else if (orders == null || !orders.Any())
    {
        <p class="empty-text">You haven't placed any orders yet.</p>
    }
    else
    {
        <div class="orders-wrapper">
            @foreach (var order in orders)
            {
                <div class="order-card">

                    <div class="order-meta">
                        <div class="order-info">
                            <span><b>Order No:</b> @order.Order.OrderNumber</span>

                            <span><b>Total:</b> ₹@order.Order.TotalAmount</span>
                        </div>


                        <div class="status-info">
                            <div class="status-actions">
                                <span style="font-weight:bold;">Order Status Action:</span>

                                <button style="background-color: #8ac8d1; color: black;"
                                        @onclick="@(() => UpdateStatus(order.Order.OrderId, "Shipped"))">
                                    Shipped
                                </button>

                                <button style="background-color: #8fbf9a; color: black;"
                                        @onclick="@(() => UpdateStatus(order.Order.OrderId, "Delivered"))">
                                    Delivered
                                </button>

                                <button style="background-color: #cf747c; color: black;"
                                        @onclick="@(() => UpdateStatus(order.Order.OrderId, "Cancelled"))">
                                    Cancel
                                </button>

                            </div>

                            <div class="oreder-status">
                                <b>Order Status:</b>
                                <span class="status-badge @(order.Order.OrderStatus.ToLower())">
                                    @order.Order.OrderStatus
                                </span>
                            </div>
                        </div>

                        <span class="payment-info">
                            <b>Payment Method:</b>
                            <span class="pay-method @(order.Order.PaymentMethod?.ToLower())">
                                @order.Order.PaymentMethod
                            </span>
                        </span>

                        <a href="https://localhost:7255/api/Manage_orders/download-invoice/@order.Order.OrderId"
                           target="_blank"
                           class="btn-view"
                           style="background:#5287e3">
                            📄 Download Bill
                        </a>
                    </div>





                    <button class="btn-view" @onclick="() => ToggleDetails(order.Order.OrderId)">
                        @(expandedOrders.Contains(order.Order.OrderId) ? "Hide Items" : "View Items")
                    </button>

                    @if (expandedOrders.Contains(order.Order.OrderId))
                    {
                        <div class="details-section">

                            <div class="items-box">
                                <h4>🧾 Order Items</h4>
                                @foreach (var item in order.Items)
                                {
                                    <div class="item-row">
                                        <img src="@GetImageUrl(item.ImageUrl)" class="item-img" />

                                        <div class="item-info">
                                            <div class="item-name">@item.ProductName</div>
                                            <div>₹@item.UnitPrice × @item.Quantity</div>
                                        </div>
                                    </div>
                                }
                            </div>

                            <!-- ADDRESS -->
                            <div class="address-box">
                                <h4>📍 Shipping Address</h4>

                                @if (order.Addresses.Any())
                                {
                                    var a = order.Addresses.First();
                                    <div class="address-text">
                                        @a.Line1 <br />
                                        @a.City, @a.State <br />
                                        @a.PostalCode
                                    </div>
                                }
                                else
                                {
                                    <div class="address-text">No address found</div>
                                }
                            </div>

                        </div>
                    }

                </div>
            }

        </div>
    }
</div>

<!-- ✔ FIXED CSS (No Compiler Conflict) -->
<style>
    .page-title {
        text-align: center;
        margin: 20px 0;
        font-size: 26px;
    }

    .orders-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 25px;
        padding: 20px;
    }

    .order-card {
        width: 1000px;
        background: white;
        border-radius: 16px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    }

    .order-meta {
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 15px;
    }

    .status-info, .order-info {
        display: flex;
        justify-content: space-between;
        width: 100%;
    }

    .status-info, .payment-info {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .status-badge {
        padding: 6px 14px;
        border-radius: 20px;
        color: black;
        font-size: 12px;
    }

        .status-badge.shipped {
            background: #8ac8d1;
        }

        .status-badge.delivered {
            background: #8fbf9a;
        }

        .status-badge.cancelled {
            background: #cf747c;
        }

        .status-badge.new {
            background: #bfad75;
            color: black;
        }


    .btn-view {
        background: black;
        color: white;
        padding: 10px 16px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        margin-bottom: 10px;
    }

    .details-section {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 25px;
        margin-top: 20px;
    }

    .items-box, .address-box {
        background: #f9f9f9;
        padding: 20px;
        border-radius: 12px;
    }

    .item-row {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 15px;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
    }

    .item-img {
        width: 80px;
        height: 80px;
        border-radius: 10px;
        object-fit: cover;
    }
</style>

@code {

    private bool isLoading = true;
    private List<OrderFullDto> orders = new();
    private HashSet<Guid> expandedOrders = new();

    protected override async Task OnInitializedAsync()
    {
        var token = await JS.InvokeAsync<string>("localStorage.getItem", "authToken");
        if (string.IsNullOrEmpty(token))
        {
            NavManager.NavigateTo("https://localhost:7291/", true);
            return;
        }

        await LoadOrders(token);
    }

    private async Task UpdateStatus(Guid orderId, string status)
    {
        try
        {
            var token = await JS.InvokeAsync<string>("localStorage.getItem", "authToken");

            Http.DefaultRequestHeaders.Authorization =
                new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);

            var res = await Http.PutAsJsonAsync(
                $"https://localhost:7255/api/Manage_orders/update-order-status/{orderId}",
                new UpdateStatusDto { OrderStatus = status });

            if (res.IsSuccessStatusCode)
            {
                await JS.InvokeVoidAsync("alert", "Status Updated Successfully!");
                await LoadOrders(token);
            }
            else
            {
                var msg = await res.Content.ReadAsStringAsync();
                await JS.InvokeVoidAsync("alert", msg);
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", ex.Message);
        }
    }

    private async Task LoadOrders(string token)
    {
        try
        {
            Http.DefaultRequestHeaders.Authorization =
                new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);

            var response = await Http.GetAsync("https://localhost:7255/api/Manage_orders/getallorders");

            if (response.IsSuccessStatusCode)
            {
                orders = await response.Content.ReadFromJsonAsync<List<OrderFullDto>>(
                    new JsonSerializerOptions { PropertyNameCaseInsensitive = true }) ?? new();
            }
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ToggleDetails(Guid orderId)
    {
        if (expandedOrders.Contains(orderId))
            expandedOrders.Remove(orderId);
        else
            expandedOrders.Add(orderId);
    }

    private string GetImageUrl(string img) =>
        string.IsNullOrEmpty(img)
        ? "https://via.placeholder.com/80?text=No+Image"
        : img;

    // ---- DTO'S ----

    public class OrderFullDto
    {
        public Order Order { get; set; } = new();
        public List<OrderItem> Items { get; set; } = new();
        public List<OrderAddress> Addresses { get; set; } = new();
    }

    public class UpdateStatusDto
    {
        public string OrderStatus { get; set; }
    }

    public class Order
    {
        public Guid OrderId { get; set; }
        public string OrderStatus { get; set; } = "";
        public decimal TotalAmount { get; set; }
        public string OrderNumber { get; set; } = "";
        public string PaymentMethod { get; set; } = "";
    }

    public class OrderItem
    {
        public Guid OrderItemId { get; set; }
        public string ProductName { get; set; } = "";
        public string ImageUrl { get; set; } = "";
        public decimal UnitPrice { get; set; }
        public int Quantity { get; set; }
    }

    public class OrderAddress
    {
        public Guid OrderAddressId { get; set; }
        public string Line1 { get; set; } = "";
        public string City { get; set; } = "";
        public string State { get; set; } = "";
        public string PostalCode { get; set; } = "";
    }
}