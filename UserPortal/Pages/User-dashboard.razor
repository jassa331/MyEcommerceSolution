@page "/user-dashboard"
@using System.Net.Http.Json
@using System.Text.Json.Serialization
@inject HttpClient Http
@inject NavigationManager NavManager
@inject IJSRuntime JS

<!-- 🔹 Header Section -->
<header style="display:flex; justify-content:space-between; align-items:center; background:#fff; padding:10px 20px; box-shadow:0 2px 10px rgba(0,0,0,0.1); flex-wrap:wrap;">

    <!-- Search + Buttons Section -->
    <div style="display:flex; align-items:center; width:100%; justify-content:space-between; flex-wrap:wrap;">

        <!-- 🔍 Search Box -->
        <div style="display:flex; max-width:400px; width:100%;">
            <input type="text"
                   placeholder="Search products..."
                   @bind="searchText"
                   style="padding:8px 10px; border-radius:5px 0 0 5px; border:1px solid #ccc; flex:1; height:40px; font-size:15px;" />
            <button @onclick="SearchProducts"
                    style="padding:0 15px; border:none; background:black; color:#fff; border-radius:0 5px 5px 0; cursor:pointer; height:40px; font-size:16px;">
                🔍
            </button>
        </div>

        <!-- 🛒 MyCart + 📦 MyOrders (Right-Aligned) -->
        <div style="display:flex; gap:15px; align-items:center;">
            <a href="user_cart"
               style="display:flex; align-items:center; justify-content:center; background:#000; color:#fff; padding:8px 15px; border-radius:8px; text-decoration:none; font-weight:600; font-size:15px; position:relative; transition:all 0.2s ease; box-shadow:0 2px 6px rgba(0,0,0,0.2); white-space:nowrap;">
                🛒 My Cart
            </a>

            <a href="user_orders"
               style="display:flex; align-items:center; justify-content:center; background:#000; color:#fff; padding:8px 15px; border-radius:8px; text-decoration:none; font-weight:600; font-size:15px; position:relative; transition:all 0.2s ease; box-shadow:0 2px 6px rgba(0,0,0,0.2); white-space:nowrap;">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none"
                     stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                     style="margin-right:6px;">
                    <path d="M16.5 9.4L7.5 4.21M21 16V8a2 2 0 0 0-1-1.73l-7-4a2
                     2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1
                     1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" />
                    <polyline points="3.27 6.96 12 12.01 20.73 6.96" />
                    <line x1="12" y1="22.08" x2="12" y2="12" />
                </svg>
                My Orders
            </a>
            <a href="user_profile" style="display:flex; align-items:center; justify-content:center; background:#000; color:#fff; padding:8px 15px; border-radius:8px; text-decoration:none; font-weight:600; font-size:15px; position:relative; transition:all 0.2s ease; box-shadow:0 2px 6px rgba(0,0,0,0.2); white-space:nowrap;">
                👤My Profile
            </a>
        </div>

    </div>
</header>

<!-- 🔹 Navigation Menu -->
<nav style="display:flex; flex-wrap:wrap; gap:10px; background:#f7f7f7; padding:10px 20px;">

    <a href="fashion" style="text-decoration:none; color:#000;">👕Fashion</a>

    <a href="electronics" style="text-decoration:none; color:#000;">📺Electronics</a>

    <a href="sports" style="text-decoration:none; color:#000;">🏋️‍Sports</a>

    <a href="homeappliances" style="text-decoration:none; color:#000;">❄️Home Appliances</a>

    <a href="books-stationery" style="text-decoration:none; color:#000;">📚Books & Stationery</a>

    <a href="beauty-personalcare" style="text-decoration:none; color:#000;">🧴Beauty & Personal Care </a>


   @*  <a href="user_checkout" style="text-decoration:none; color:#000;">orders</a> *@
   @*  <a href="user_profile" style="text-decoration:none; color:#000;">My Profile</a> *@
    
</nav>

<!-- 🔹 Main Product Display -->
<main style="padding:20px;">
    @if (filteredProducts == null)
    {
        <p>Loading products...</p>
    }
    else if (!filteredProducts.Any())
    {
        <p>No products found.</p>
    }
    else
    {
        <h1 style="color:black;">All Products</h1>

        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:20px;">
            @foreach (var product in filteredProducts)
            {
                <div style="background:#fff; border-radius:10px; padding:15px; text-align:center; box-shadow:0 4px 10px rgba(0,0,0,0.1);">
                    <!-- Image -->
                    <div style="cursor:pointer;" @onclick="() => GoToProductDetails(product.Name)">
                        <img src="@GetFullImageUrl(product.ImageUrl)" alt="@product.Name"
                             style="width:100%; height:200px; object-fit:cover; border-radius:8px;" />
                    </div>

                    <!-- Product Info -->
                    <h4 style="cursor:pointer; margin-top:10px;" @onclick="() => GoToProductDetails(product.Name)">
                        @product.Name
                    </h4>
                    <p>@product.Description</p>
                    <p style="color:#ff9900; font-weight:bold;">Price: ₹@product.Price</p>

                    <!-- 🔹 Quantity Selector -->
                    <div style="display:flex; justify-content:center; align-items:center; gap:8px; margin-top:5px;">
                        <button @onclick="() => DecreaseQuantity(product.ProductId)"
                                style="width:28px; height:28px; border:none; background:#ccc; color:black; border-radius:4px; cursor:pointer;">
                            −
                        </button>

                        <span style="min-width:25px; display:inline-block;">@GetQuantity(product.ProductId)</span>

                        <button @onclick="() => IncreaseQuantity(product.ProductId)"
                                style="width:28px; height:28px; border:none; background:#ccc; color:black; border-radius:4px; cursor:pointer;">
                            +
                        </button>
                    </div>

                    <!-- Add to Cart -->
                    <button @onclick="() => AddToCart(product)"
                            style="background:black; color:#fff; border:none; padding:8px 10px; border-radius:5px; cursor:pointer; margin-top:10px;">
                        Add to Cart 🛒
                    </button>
                </div>
            }
        </div>
    }
</main>

@code {
    // 🔹 Local variables
    private string searchText = "";
    private List<ProductImage> allProducts = new();
    private List<ProductImage> filteredProducts = new();
    private Dictionary<Guid, int> productQuantities = new(); // Track quantity per product
    private Guid? currentUserId = null;
    private string? token;

    // 🔹 Initialization
    protected override async Task OnInitializedAsync()
    {
        token = await JS.InvokeAsync<string>("localStorage.getItem", "authToken");
        var idString = await JS.InvokeAsync<string>("localStorage.getItem", "userId");

        if (string.IsNullOrEmpty(token) || string.IsNullOrEmpty(idString))
        {
            await JS.InvokeVoidAsync("alert", "Please login first!");
            NavManager.NavigateTo("/");
            return;
        }

        currentUserId = Guid.Parse(idString);

        allProducts = await Http.GetFromJsonAsync<List<ProductImage>>("https://localhost:7117/api/ProductImage/GetAll");
        filteredProducts = allProducts;

        // Initialize all product quantities to 1
        foreach (var product in allProducts)
        {
            productQuantities[product.ProductId] = 1;
        }
    }

    // 🔹 Quantity Controls
    private int GetQuantity(Guid productId)
    {
        return productQuantities.ContainsKey(productId) ? productQuantities[productId] : 1;
    }

    private void IncreaseQuantity(Guid productId)
    {
        if (productQuantities.ContainsKey(productId))
            productQuantities[productId]++;
        else
            productQuantities[productId] = 1;
    }

    private void DecreaseQuantity(Guid productId)
    {
        if (productQuantities.ContainsKey(productId) && productQuantities[productId] > 1)
            productQuantities[productId]--;
    }

    // 🔹 Add Product to Cart
    private async Task AddToCart(ProductImage product)
    {
        if (currentUserId == null)
        {
            await JS.InvokeVoidAsync("alert", "Please login first!");
            return;
        }

        int quantity = GetQuantity(product.ProductId);

        var cartItem = new
        {
            ProductId = product.ProductId,
            ProductName = product.Name,
            ProductDescription = product.Description,
            ProductPrice = product.Price,
            Quantity = quantity,
            ProductImageUrl = product.ImageUrl
        };



        try
        {
            var request = new HttpRequestMessage(HttpMethod.Post, "https://localhost:7117/api/Cart/Add")
            {
                Content = JsonContent.Create(cartItem)
            };
            request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);

            var response = await Http.SendAsync(request);

            if (response.IsSuccessStatusCode)
                await JS.InvokeVoidAsync("alert", $"{product.Name} (x{quantity}) added to your cart!");
            else
            {
                var err = await response.Content.ReadAsStringAsync();
                await JS.InvokeVoidAsync("alert", $"❌ Failed: {response.StatusCode} → {err}");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
        }
    }

    // 🔹 Search Functionality
    private void SearchProducts()
    {
        if (string.IsNullOrWhiteSpace(searchText))
            filteredProducts = allProducts;
        else
            filteredProducts = allProducts
                .Where(p => p.Name.Contains(searchText, StringComparison.OrdinalIgnoreCase))
                .ToList();
    }

    // 🔹 Product Navigation
    private void GoToProductDetails(string productName)
    {
        NavManager.NavigateTo($"/product/{Uri.EscapeDataString(productName)}");
    }

    // 🔹 Image Helper
    private string GetFullImageUrl(string relativeUrl)
    {
        if (string.IsNullOrWhiteSpace(relativeUrl)) return "images/noimage.png";
        if (relativeUrl.StartsWith("http")) return relativeUrl;
        return $"https://localhost:7066/{relativeUrl.TrimStart('/')}";
    }

    // 🔹 Model Class
    public class ProductImage
    {
        public Guid ProductId { get; set; }
        public string Name { get; set; } = "";
        public string Description { get; set; } = "";
        public decimal Price { get; set; }
        public string ImageUrl { get; set; } = "";
    }
}
